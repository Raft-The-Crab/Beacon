FROM node:20-alpine

WORKDIR /app

# Install canvas dependencies (for image processing)
RUN apk add --no-cache \
    cairo-dev \
    jpeg-dev \
    pango-dev \
    giflib-dev \
    pixman-dev

# Copy package files
COPY package*.json pnpm-*.yaml ./
COPY apps/server/package*.json ./apps/server/

# Install dependencies
RUN npm install -g pnpm && \
    pnpm install --filter @beacon/server

# Copy AI model and server files
COPY apps/server/ai ./apps/server/ai
COPY apps/server/src/ai-server.ts ./apps/server/src/

WORKDIR /app/apps/server

# Set memory limits for 1GB RAM
ENV NODE_ENV=production
ENV PORT=8081
ENV NODE_OPTIONS=--max-old-space-size=768

EXPOSE 8081

# Run with tsx (no build needed)
CMD ["npx", "tsx", "src/ai-server.ts"]
